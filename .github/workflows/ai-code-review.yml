name: AI-Powered PR Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install
        continue-on-error: true

      - name: Rebuild native modules
        run: npm rebuild
        continue-on-error: true

      - name: Run ESLint
        id: lint
        run: |
          npm run lint 2>&1 | tee lint-output.txt || echo "Lint failed"
          if grep -q "error" lint-output.txt; then
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run Tests with Coverage
        id: tests
        run: |
          npm run test:ci 2>&1 | tee test-output.txt || echo "Tests failed"
          if [ -f coverage/coverage-summary.json ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            src/**/*.ts
            src/**/*.html
            src/**/*.css

      - name: Run Code Analysis
        id: code-analysis
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}" npm run ai:analyze > code-analysis.json || true
          cat code-analysis.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat code-analysis.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run Coverage Analysis
        id: coverage-analysis
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}" npm run ai:coverage > coverage-analysis.json || true
          cat coverage-analysis.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat coverage-analysis.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run Security Scan
        id: security-scan
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}" npm run ai:security > security-scan.json || true
          cat security-scan.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat security-scan.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Analyze PR Metadata
        id: pr-analysis
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}" \
          PR_DESCRIPTION="${{ github.event.pull_request.body }}" \
          PR_HEAD_REF="${{ github.head_ref }}" \
          PR_ADDITIONS="${{ github.event.pull_request.additions }}" \
          PR_DELETIONS="${{ github.event.pull_request.deletions }}" \
          PR_CHANGED_FILES="${{ github.event.pull_request.changed_files }}" \
          npm run ai:pr > pr-analysis.json || true
          cat pr-analysis.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat pr-analysis.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Calculate AI Score
        id: ai-score
        run: |
          cat > calculate-score.js << 'EOF'
          const fs = require('fs');

          // Read analysis results
          const analysis = JSON.parse(fs.readFileSync('analysis-result.json', 'utf8'));
          
          // Read PR info
          const prTitle = process.env.PR_TITLE;
          const prDescription = process.env.PR_DESCRIPTION;
          
          let score = analysis.score;
          const checks = [];

          // Lint score check
          const lintPassed = process.env.LINT_STATUS === 'success';
          if (lintPassed) {
            checks.push({ severity: 'info', message: 'âœ“ ESLint: All checks passed' });
            score += 5;
          } else {
            checks.push({ severity: 'error', message: 'âœ— ESLint: Issues found' });
            score -= 15;
          }

          // Test status check
          const testPassed = process.env.TEST_STATUS === 'success';
          if (testPassed) {
            checks.push({ severity: 'info', message: 'âœ“ Tests: All passing' });
            score += 5;
          } else {
            checks.push({ severity: 'error', message: 'âœ— Tests: Some tests failing' });
            score -= 20;
          }

          // PR title check

      - name: Calculate Final Score
        id: final-score
        run: |
          node -e "
          const fs = require('fs');
          
          // Read all analysis results
          const codeAnalysis = JSON.parse(fs.readFileSync('code-analysis.json', 'utf8'));
          const coverageAnalysis = JSON.parse(fs.readFileSync('coverage-analysis.json', 'utf8'));
          const securityScan = JSON.parse(fs.readFileSync('security-scan.json', 'utf8'));
          const prAnalysis = JSON.parse(fs.readFileSync('pr-analysis.json', 'utf8'));
          
          // Calculate weighted final score
          let finalScore = 0;
          const weights = {
            code: 0.35,
            coverage: 0.25,
            security: 0.25,
            pr: 0.15
          };
          
          finalScore += (codeAnalysis.score || 0) * weights.code;
          finalScore += (coverageAnalysis.coverage?.passed ? 100 : 50) * weights.coverage;
          finalScore += (securityScan.audit?.passed ? 100 : 60) * weights.security;
          finalScore += (prAnalysis.score || 80) * weights.pr;
          
          // Collect all issues
          const allIssues = [
            ...(codeAnalysis.issues || []),
            ...(coverageAnalysis.coverage?.issues || []),
            ...(securityScan.audit?.issues || []),
            ...(securityScan.fileIssues || []),
            ...(prAnalysis.issues || [])
          ];
          
          // Determine recommendation
          const criticalIssues = allIssues.filter(i => i.severity === 'error').length;
          const lintPassed = '${{ steps.lint.outputs.status }}' === 'success';
          const testsPassed = '${{ steps.tests.outputs.status }}' === 'success';
          
          const shouldApprove = finalScore >= 85 && criticalIssues === 0 && lintPassed && testsPassed;
          
          const result = {
            score: Math.round(finalScore),
            recommendation: shouldApprove ? 'APPROVE' : 'REQUEST_CHANGES',
            breakdown: {
              code: Math.round((codeAnalysis.score || 0)),
              coverage: coverageAnalysis.coverage?.passed ? 100 : 50,
              security: securityScan.audit?.passed ? 100 : 60,
              pr: Math.round(prAnalysis.score || 80)
            },
            checks: {
              lint: lintPassed,
              tests: testsPassed,
              criticalIssues: criticalIssues
            },
            issues: allIssues,
            metrics: {
              filesAnalyzed: codeAnalysis.metrics?.filesAnalyzed || 0,
              linesAnalyzed: codeAnalysis.metrics?.linesAnalyzed || 0,
              vulnerabilities: securityScan.audit?.totalVulnerabilities || 0
            }
          };
          
          fs.writeFileSync('final-result.json', JSON.stringify(result, null, 2));
          console.log(JSON.stringify(result, null, 2));
          " || true
          cat final-result.json
        continue-on-error: true

      - name: Post AI Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let result;
            try {
              result = JSON.parse(fs.readFileSync('final-result.json', 'utf8'));
            } catch (e) {
              result = {
                score: 0,
                recommendation: 'ERROR',
                breakdown: {},
                checks: {},
                issues: [],
                metrics: {}
              };
            }
            
            // Build comprehensive comment
            let comment = '## ðŸ¤– AI-Powered Code Review\n\n';
            
            // Overall score with visual indicator
            comment += '### Overall Score\n';
            comment += `**${result.score}/100** `;
            if (result.score >= 90) comment += 'ðŸŸ¢ Excellent\n';
            else if (result.score >= 80) comment += 'ðŸŸ¡ Good\n';
            else if (result.score >= 70) comment += 'ðŸŸ  Needs Improvement\n';
            else comment += 'ðŸ”´ Critical Issues\n';
            
            comment += `\n**Recommendation:** ${result.recommendation === 'APPROVE' ? 'âœ… Approve' : 'âš ï¸ Request Changes'}\n\n`;
            
            // Score breakdown
            comment += '### Score Breakdown\n';
            comment += '| Category | Score | Weight |\n';
            comment += '|----------|-------|--------|\n';
            comment += `| Code Quality | ${result.breakdown.code}/100 | 35% |\n`;
            comment += `| Test Coverage | ${result.breakdown.coverage}/100 | 25% |\n`;
            comment += `| Security | ${result.breakdown.security}/100 | 25% |\n`;
            comment += `| PR Metadata | ${result.breakdown.pr}/100 | 15% |\n\n`;
            
            // Key metrics
            comment += '### Metrics\n';
            comment += `- **Files Analyzed:** ${result.metrics.filesAnalyzed}\n`;
            comment += `- **Lines Analyzed:** ${result.metrics.linesAnalyzed}\n`;
            comment += `- **Lint:** ${result.checks.lint ? 'âœ… Pass' : 'âŒ Fail'}\n`;
            comment += `- **Tests:** ${result.checks.tests ? 'âœ… Pass' : 'âŒ Fail'}\n`;
            comment += `- **Vulnerabilities:** ${result.metrics.vulnerabilities}\n\n`;
            
            // Group issues by severity
            const errors = result.issues.filter(i => i.severity === 'error');
            const warnings = result.issues.filter(i => i.severity === 'warning');
            const infos = result.issues.filter(i => i.severity === 'info');
            
            if (errors.length > 0) {
              comment += `### âŒ Critical Issues (${errors.length})\n`;
              errors.slice(0, 10).forEach(e => {
                comment += `- **[${e.category || 'Error'}]** ${e.message}\n`;
                if (e.file) comment += `  \`${e.file}\`\n`;
              });
              if (errors.length > 10) {
                comment += `\n_... and ${errors.length - 10} more error(s)_\n`;
              }
              comment += '\n';
            }
            
            if (warnings.length > 0) {
              comment += `### âš ï¸ Warnings (${warnings.length})\n`;
              warnings.slice(0, 8).forEach(w => {
                comment += `- **[${w.category || 'Warning'}]** ${w.message}\n`;
              });
              if (warnings.length > 8) {
                comment += `\n_... and ${warnings.length - 8} more warning(s)_\n`;
              }
              comment += '\n';
            }
            
            if (infos.length > 0) {
              comment += `### âœ… Passed Checks (${infos.length})\n`;
              infos.slice(0, 5).forEach(i => {
                comment += `- ${i.message}\n`;
              });
              if (infos.length > 5) {
                comment += `\n_... and ${infos.length - 5} more check(s) passed_\n`;
              }
              comment += '\n';
            }
            
            comment += '---\n';
            comment += '*AI Review powered by advanced static analysis. For questions, see [DEVELOPMENT.md](./DEVELOPMENT.md)*\n';
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Fail workflow if score too low
            if (result.score < 70 || result.checks.criticalIssues > 0) {
              core.setFailed(`AI Review: Score ${result.score}/100 with ${result.checks.criticalIssues} critical issue(s)`);
            }

                comment += `- ${i.message}\n`;
              });
              comment += '\n';
            }

            comment += '---\n';
            comment += '*This review was automated by AI Code Review Bot. For manual review, see your reviewers.*\n';

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            // Set status
            if (aiResult.score < 75) {
              core.setFailed('AI Review: Code does not meet quality standards');
            }
