name: AI-Powered PR Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install
        continue-on-error: true

      - name: Rebuild native modules
        run: npm rebuild
        continue-on-error: true

      - name: Run ESLint
        id: lint
        run: |
          npm run lint 2>&1 | tee lint-output.txt || echo "Lint failed"
          if grep -q "error" lint-output.txt; then
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run Tests with Coverage
        id: tests
        run: |
          npm run test:ci 2>&1 | tee test-output.txt || echo "Tests failed"
          if [ -f coverage/coverage-summary.json ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            src/**/*.ts
            src/**/*.html
            src/**/*.css

      - name: Run Code Analysis
        id: code-analysis
        run: |
          echo "Changed files: ${CHANGED_FILES}"
          if [ -z "$CHANGED_FILES" ]; then
            echo '{"score":100,"issues":[],"metrics":{"filesAnalyzed":0,"linesAnalyzed":0}}' > code-analysis.json
          else
            npm run ai:analyze > code-analysis.json 2>&1 || echo '{"score":0,"issues":[{"severity":"error","message":"Code analysis failed"}],"metrics":{}}' > code-analysis.json
          fi
          echo "Code analysis output:"
          cat code-analysis.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat code-analysis.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Run Coverage Analysis
        id: coverage-analysis
        run: |
          if [ -z "$CHANGED_FILES" ]; then
            echo '{"coverage":{"passed":true,"issues":[]},"testFiles":{"passed":true}}' > coverage-analysis.json
          else
            npm run ai:coverage > coverage-analysis.json 2>&1 || echo '{"coverage":{"passed":false,"issues":[{"severity":"error","message":"Coverage analysis failed"}]}}' > coverage-analysis.json
          fi
          echo "Coverage analysis output:"
          cat coverage-analysis.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat coverage-analysis.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Run Security Scan
        id: security-scan
        run: |
          npm run ai:security > security-scan.json 2>&1 || echo '{"audit":{"passed":true,"issues":[],"totalVulnerabilities":0},"fileIssues":[]}' > security-scan.json
          echo "Security scan output:"
          cat security-scan.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat security-scan.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Analyze PR Metadata
        id: pr-analysis
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}" \
          PR_DESCRIPTION="${{ github.event.pull_request.body }}" \
          PR_HEAD_REF="${{ github.head_ref }}" \
          PR_ADDITIONS="${{ github.event.pull_request.additions }}" \
          PR_DELETIONS="${{ github.event.pull_request.deletions }}" \
          PR_CHANGED_FILES="${{ github.event.pull_request.changed_files }}" \
          npm run ai:pr > pr-analysis.json || true
          cat pr-analysis.json
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat pr-analysis.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Calculate Final Score
        id: final-score
        run: |
          node -e "
          const fs = require('fs');
          
          // Helper to safely read JSON files
          function readJsonFile(filepath, defaultValue) {
            try {
              if (!fs.existsSync(filepath)) {
                console.error('File not found:', filepath);
                return defaultValue;
              }
              const content = fs.readFileSync(filepath, 'utf8').trim();
              if (!content) {
                console.error('Empty file:', filepath);
                return defaultValue;
              }
              return JSON.parse(content);
            } catch (e) {
              console.error('Error reading', filepath, ':', e.message);
              return defaultValue;
            }
          }
          
          // Read all analysis results with fallbacks
          const codeAnalysis = readJsonFile('code-analysis.json', { score: 0, issues: [], metrics: {} });
          const coverageAnalysis = readJsonFile('coverage-analysis.json', { coverage: { passed: false, issues: [] } });
          const securityScan = readJsonFile('security-scan.json', { audit: { passed: true, issues: [], totalVulnerabilities: 0 }, fileIssues: [] });
          const prAnalysis = readJsonFile('pr-analysis.json', { score: 80, issues: [] });
          
          // Calculate weighted final score
          let finalScore = 0;
          const weights = {
            code: 0.35,
            coverage: 0.25,
            security: 0.25,
            pr: 0.15
          };
          
          const codeScore = codeAnalysis.score || 0;
          const coverageScore = coverageAnalysis.coverage?.passed ? 100 : 50;
          const securityScore = securityScan.audit?.passed ? 100 : 60;
          const prScore = prAnalysis.score || 80;
          
          finalScore += codeScore * weights.code;
          finalScore += coverageScore * weights.coverage;
          finalScore += securityScore * weights.security;
          finalScore += prScore * weights.pr;
          
          // Collect all issues
          const allIssues = [
            ...(codeAnalysis.issues || []),
            ...(coverageAnalysis.coverage?.issues || []),
            ...(securityScan.audit?.issues || []),
            ...(securityScan.fileIssues || []),
            ...(prAnalysis.issues || [])
          ];
          
          // Determine recommendation
          const criticalIssues = allIssues.filter(i => i.severity === 'error').length;
          const lintPassed = '${{ steps.lint.outputs.status }}' === 'success';
          const testsPassed = '${{ steps.tests.outputs.status }}' === 'success';
          
          const shouldApprove = finalScore >= 85 && criticalIssues === 0 && lintPassed && testsPassed;
          
          const result = {
            score: Math.round(finalScore),
            recommendation: shouldApprove ? 'APPROVE' : 'REQUEST_CHANGES',
            breakdown: {
              code: Math.round(codeScore),
              coverage: coverageScore,
              security: securityScore,
              pr: Math.round(prScore)
            },
            checks: {
              lint: lintPassed,
              tests: testsPassed,
              criticalIssues: criticalIssues
            },
            issues: allIssues,
            metrics: {
              filesAnalyzed: codeAnalysis.metrics?.filesAnalyzed || 0,
              linesAnalyzed: codeAnalysis.metrics?.linesAnalyzed || 0,
              vulnerabilities: securityScan.audit?.totalVulnerabilities || 0
            }
          };
          
          fs.writeFileSync('final-result.json', JSON.stringify(result, null, 2));
          console.log(JSON.stringify(result, null, 2));
          " || true
          cat final-result.json
        continue-on-error: true

      - name: Post AI Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let result;
            try {
              result = JSON.parse(fs.readFileSync('final-result.json', 'utf8'));
            } catch (e) {
              result = {
                score: 0,
                recommendation: 'ERROR',
                breakdown: { code: 0, coverage: 0, security: 0, pr: 0 },
                checks: { lint: false, tests: false, criticalIssues: 0 },
                issues: [{
                  severity: 'error',
                  message: 'Failed to generate AI review report: ' + e.message
                }],
                metrics: { filesAnalyzed: 0, linesAnalyzed: 0, vulnerabilities: 0 }
              };
            }
            
            // Ensure all required fields exist
            result.breakdown = result.breakdown || { code: 0, coverage: 0, security: 0, pr: 0 };
            result.checks = result.checks || { lint: false, tests: false, criticalIssues: 0 };
            result.metrics = result.metrics || { filesAnalyzed: 0, linesAnalyzed: 0, vulnerabilities: 0 };
            result.issues = result.issues || [];
            
            // Build comprehensive comment
            let comment = '## ðŸ¤– AI-Powered Code Review\n\n';
            
            // Overall score with visual indicator
            comment += '### Overall Score\n';
            comment += `**${result.score || 0}/100** `;
            if (result.score >= 90) comment += 'ðŸŸ¢ Excellent\n';
            else if (result.score >= 80) comment += 'ðŸŸ¡ Good\n';
            else if (result.score >= 70) comment += 'ðŸŸ  Needs Improvement\n';
            else comment += 'ðŸ”´ Critical Issues\n';
            
            comment += `\n**Recommendation:** ${result.recommendation === 'APPROVE' ? 'âœ… Approve' : 'âš ï¸ Request Changes'}\n\n`;
            
            // Score breakdown
            comment += '### Score Breakdown\n';
            comment += '| Category | Score | Weight |\n';
            comment += '|----------|-------|--------|\n';
            comment += `| Code Quality | ${result.breakdown.code || 0}/100 | 35% |\n`;
            comment += `| Test Coverage | ${result.breakdown.coverage || 0}/100 | 25% |\n`;
            comment += `| Security | ${result.breakdown.security || 0}/100 | 25% |\n`;
            comment += `| PR Metadata | ${result.breakdown.pr || 0}/100 | 15% |\n\n`;
            
            // Key metrics
            comment += '### Metrics\n';
            comment += `- **Files Analyzed:** ${result.metrics.filesAnalyzed || 0}\n`;
            comment += `- **Lines Analyzed:** ${result.metrics.linesAnalyzed || 0}\n`;
            comment += `- **Lint:** ${result.checks.lint ? 'âœ… Pass' : 'âŒ Fail'}\n`;
            comment += `- **Tests:** ${result.checks.tests ? 'âœ… Pass' : 'âŒ Fail'}\n`;
            comment += `- **Vulnerabilities:** ${result.metrics.vulnerabilities || 0}\n\n`;
            
            // Group issues by severity
            const errors = result.issues.filter(i => i.severity === 'error');
            const warnings = result.issues.filter(i => i.severity === 'warning');
            const infos = result.issues.filter(i => i.severity === 'info');
            
            if (errors.length > 0) {
              comment += `### âŒ Critical Issues (${errors.length})\n`;
              errors.slice(0, 10).forEach(e => {
                comment += `- **[${e.category || 'Error'}]** ${e.message}\n`;
                if (e.file) comment += `  \`${e.file}\`\n`;
              });
              if (errors.length > 10) {
                comment += `\n_... and ${errors.length - 10} more error(s)_\n`;
              }
              comment += '\n';
            }
            
            if (warnings.length > 0) {
              comment += `### âš ï¸ Warnings (${warnings.length})\n`;
              warnings.slice(0, 8).forEach(w => {
                comment += `- **[${w.category || 'Warning'}]** ${w.message}\n`;
              });
              if (warnings.length > 8) {
                comment += `\n_... and ${warnings.length - 8} more warning(s)_\n`;
              }
              comment += '\n';
            }
            
            if (infos.length > 0) {
              comment += `### âœ… Passed Checks (${infos.length})\n`;
              infos.slice(0, 5).forEach(i => {
                comment += `- ${i.message}\n`;
              });
              if (infos.length > 5) {
                comment += `\n_... and ${infos.length - 5} more check(s) passed_\n`;
              }
              comment += '\n';
            }
            
            comment += '---\n';
            comment += '*AI Review powered by advanced static analysis. For questions, see [DEVELOPMENT.md](./DEVELOPMENT.md)*\n';
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Fail workflow if score too low
            if (result.score < 70 || result.checks.criticalIssues > 0) {
              core.setFailed(`AI Review: Score ${result.score}/100 with ${result.checks.criticalIssues} critical issue(s)`);
            }
